<!DOCTYPE HTML>

<html>
    <head>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z0NSFPKNBN">
        </script>
        <script>
            window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Z0NSFPKNBN');
        </script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
        <title>
            Type-safe links - Servant by construction part 2 - Laurent P. René de Cotret
        </title>
        <link rel="icon" type="image/x-icon" href="../../images/atom-solid.png">
        <link rel="stylesheet" type="text/css" href="../../css/syntax.css">
        <link rel="stylesheet" type="text/css" href="../../css/style.css">
        <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css">
        <link rel="stylesheet" type="font" href="https://fonts.googleapis.com/css?family=Titillium+Web">
        <script type="text/javascript" src="../../js/navbar-onclick.js">
        </script>
    </head>
    <body>
        <section class="hero-with-background is-dark">
            <div class="hero-head">
                <nav class="navbar is-transparent">
                    <div class="container">
                        <div class="navbar-brand">
                            <a class="navbar-item has-text-light" href="../../index.html">
                                <strong>
                                    Laurent P. René de Cotret
                                </strong>
                            </a>
                            <span class="navbar-burger burger has-text-light" id="burger" onclick="toggleBurger()">
                                <span>
                                </span>
                                <span>
                                </span>
                                <span>
                                </span>
                            </span>
                        </div>
                        <div class="navbar-menu" id="navbarMenu">
                            <div class="navbar-end">
                                <a class="navbar-item" href="../../index.html">
                                    Home
                                </a>
                                <a class="navbar-item" href="../../software.html">
                                    Software
                                </a>
                                <a class="navbar-item" href="../../publications.html">
                                    Publications
                                </a>
                                <a class="navbar-item" href="../../about.html">
                                    About me
                                </a>
                                <a class="navbar-item" href="../../archive.html">
                                    All blog posts
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="hero-body">
                <div class="container has-text-centered">
                    <h1 class="title has-text-light">
                        Type-safe links - Servant by construction part 2
                    </h1>
                    <h3>
                        
                        Posted on 2025-09-29. 
                        
                        
                        Last updated on 2025-09-30.
                        
                    </h3>
                    <h3>
                        
                        Estimated reading time of 14 min.
                        
                    </h3>
                    <h3>
                        
                        <span class="icon has-text-link">
                            <i class="fas fa-tag">
                            </i>
                        </span>
                         Tags: <a title="All pages tagged 'haskell'." href="../../tags/haskell.html" rel="tag">haskell</a>, <a title="All pages tagged 'servant by construction'." href="../../tags/servant%20by%20construction.html" rel="tag">servant by construction</a>, <a title="All pages tagged 'software engineering'." href="../../tags/software%20engineering.html" rel="tag">software engineering</a>, <a title="All pages tagged 'web'." href="../../tags/web.html" rel="tag">web</a>
                        
                    </h3>
                </div>
            </div>
            <div class="hero-foot">
                <div class="navbar is-transparent">
                    <div class="container">
                        <div class="navbar-menu">
                            <div class="navbar-start">
                                <a class="navbar-item has-text-light" target="_blank" href="../../email.html">
                                    <span class="icon is-medium">
                                        <i class="fas fa-envelope">
                                        </i>
                                    </span>
                                    e-mail
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://github.com/LaurentRDC">
                                    <span class="icon is-medium">
                                        <i class="fab fa-github">
                                        </i>
                                    </span>
                                    GitHub
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://www.linkedin.com/in/laurentrdc">
                                    <span class="icon is-medium">
                                        <i class="fab fa-linkedin">
                                        </i>
                                    </span>
                                    LinkedIn
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://www.researchgate.net/profile/Laurent_Rene_De_Cotret">
                                    <span class="icon is-medium">
                                        <i class="ai ai-researchgate">
                                        </i>
                                    </span>
                                    ResearchGate
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://orcid.org/0000-0002-1464-2739">
                                    <span class="icon is-medium">
                                        <i class="ai ai-orcid">
                                        </i>
                                    </span>
                                    OrcID
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://scholar.google.ca/citations?user=pXFhwioAAAAJ&amp;hl=en">
                                    <span class="icon is-medium">
                                        <i class="ai ai-google-scholar">
                                        </i>
                                    </span>
                                    Google Scholar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="section">
            <div class="container">
                <div class="content">
                    <p>Recall <a href="../../posts/servant-by-construction/ApiAsType.html">the previous post in this series</a>: we created a bunch of types, such as <code>Get</code>, <code>Capture</code>, and <code>(:&gt;)</code>, to help us represent an API. So far, we can’t do squat with these types, but that changes today. By the end of this post, we’ll be able to do <em>one</em> thing: we’ll determine the string representation of an endpoint type.</p>
<p>I know, this isn’t mindblowing, but it will require the use of a basic technique that most Servant functionality uses: the <code>Proxy</code> type. This tool (and others!) will be used again and again as we re-build more powerful components of Servant.</p>
<hr>
<p>This file is a Literate Haskell module, so we have to get some ceremony out-of-the-way.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE DataKinds #-}</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">TypeSafeLinks</span> <span class="kw">where</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- From the previous post in this series</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">ApiAsType</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    ( (<span class="op">:&gt;</span>),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Capture</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">City</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Get</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Post</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="dt">QueryParam</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ReqBody</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Temperature</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">-- we'll need these later on</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.List</span> (intersperse)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Proxy</span> (<span class="dt">Proxy</span>(..))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Time</span> (<span class="dt">Day</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">GHC.TypeLits</span> (<span class="dt">KnownSymbol</span>, symbolVal)</span></code></pre></div>
<p>Here’s what we want to do: given the type associated with an endpoint, we want a string that represents a <a href="https://en.wikipedia.org/w/index.php?title=Uniform_Resource_Identifier&amp;oldid=1278623925">universal resource identifier</a> to this endpoint, in the form of a <em>link</em><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Simply put, for every <em>segment</em> of an endpoint, we want a piece of string that represents it. For example, the endpoint represented by the type</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ForecastLastUpdated</span> <span class="ot">=</span> <span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="st">&quot;lastupdated&quot;</span> <span class="op">:&gt;</span> <span class="dt">Get</span> <span class="dt">UTCTime</span></span></code></pre></div>
<p>should give us the link</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;/forecast/lastupdated&quot;</span></span></code></pre></div>
<p>, while the endpoint represented by the type</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ForecastTemperature</span> <span class="ot">=</span> <span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;date&quot;</span> <span class="dt">Day</span> <span class="op">:&gt;</span> <span class="st">&quot;temperature&quot;</span> <span class="op">:&gt;</span> <span class="dt">Get</span> <span class="dt">Temperature</span></span></code></pre></div>
<p>should give us the link</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;/forecast/&lt;date&gt;/temperature&quot;</span></span></code></pre></div>
<p>Recall that the segments <code>"forecast"</code>, <code>"lastupdated"</code>, and <code>"temperature"</code> are <em>type-level strings</em>, or <code>Symbol</code>s. The links, such as <code>"/forecast/lastupdated"</code>, <em>will be represented</em> by term-level strings:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Link</span> <span class="ot">=</span> [<span class="dt">String</span>]</span></code></pre></div>
<hr>
<p>Before we break out the advanced type stuff, let’s build this functionality as if we represented our API not with a type, but with data. We’ll focus on only one of the endpoints, specifically the endpoint given by the type:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ForecastLastUpdated</span> <span class="ot">=</span> <span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="st">&quot;lastupdated&quot;</span> <span class="op">:&gt;</span> <span class="dt">Get</span> <span class="dt">UTCTime</span></span></code></pre></div>
<p>Imagine if we instead represented that endpoint using the following construction:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">APIComponent</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="dt">Get</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Segment</span> <span class="dt">String</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Join</span> <span class="dt">APIComponent</span> <span class="dt">APIComponent</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="ot">exampleEndpoint ::</span> <span class="dt">APIComponent</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>exampleEndpoint <span class="ot">=</span> <span class="dt">Segment</span> <span class="st">&quot;forecast&quot;</span> <span class="ot">`Join`</span> <span class="dt">Segment</span> <span class="st">&quot;lastupdated&quot;</span> <span class="ot">`Join`</span> <span class="dt">Get</span></span></code></pre></div>
<p>Extracting the link from such a value can be done recursively:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">endpointLink ::</span> <span class="dt">APIComponent</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Link</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>endpointLink <span class="ot">=</span> <span class="fu">fmap</span> (intersperse <span class="st">&quot;/&quot;</span>) <span class="op">.</span> go [root]</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ot">    root ::</span> <span class="dt">String</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    root <span class="ot">=</span> <span class="st">&quot;/&quot;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    go ::</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">APIComponent</span> <span class="ot">-&gt;</span> <span class="dt">Either</span> <span class="dt">String</span> <span class="dt">Link</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    go accumulator <span class="dt">Get</span> <span class="ot">=</span> <span class="dt">Right</span> accumulator</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    go accumulator (<span class="dt">Join</span> (<span class="dt">Segment</span> segment) component) <span class="ot">=</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        go (accumulator <span class="op">&lt;&gt;</span> [segment]) component</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- Any other structure is considered a malformed API</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    go _ _ <span class="ot">=</span> <span class="dt">Left</span> <span class="st">&quot;Endpoint structure doesn't make sense&quot;</span></span></code></pre></div>
<p>(Sidenote: please forgive me for appending to a linked list; I’m trying to keep things as simple as possible.)</p>
<p>The result would be:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> ghci<span class="op">&gt;</span> endpointLink exampleEndpoint</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;/forecast/lastupdated&quot;</span></span></code></pre></div>
<p>The key concept in <code>endpointLink</code> is that we recursively walk over the parts of the endpoint until we hit a verb, in this case <code>Get</code>, while accumulating parts of the link. When we build this functionality for type-level API definitions, we’ll do something very similar: we’ll walk over all components of the API type with a function, accumulating parts of the link, until we hit a terminal verb.</p>
<p>Note that we had to handle the case of nonsensical API structures at runtime. In this case, the only valid API are those composed of zero or more <code>Segment</code>s ultimately ending in <code>Get</code>, all joined with <code>Join</code>. Any other structure results in an error, represented by <code>Left "..."</code>.</p>
<hr>
<p>Let’s move back to the world of APIs defined as types.</p>
<p>The component of an API type, like <code>Capture</code> or a type-level symbol <code>"forecast"</code>, is associated with zero or more segments. This type-level “case-by-case” is the realm of <strong>typeclasses</strong>. We want to create a typeclass, and apply it recursively over our API type, building from the base link <code>"/"</code> incrementally. Let’s <em>try</em> to create this typeclass:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">HasLink1</span> endpoint <span class="kw">where</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink1 ::</span> <span class="dt">Link</span> <span class="co">-- ^ base link, initially just &quot;/&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- Example</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLink1</span> <span class="st">&quot;forecast&quot;</span> <span class="kw">where</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink1 ::</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    toLink1 baselink <span class="ot">=</span> [baselink, <span class="st">&quot;forecast&quot;</span>]</span></code></pre></div>
<p>Unfortunately, this is not going to compile. The problem is that type inference won’t work; given a <code>toLink1</code> in the middle of a Haskell file, how can the compiler know which <code>endpoint</code> type it refers to? It can’t know. We need to inject type information in the signature of <code>toLink1</code>.</p>
<p>How about this?</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">HasLink2</span> endpoint <span class="kw">where</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink2 ::</span> <span class="dt">Link</span> <span class="co">-- ^ base link</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> endpoint</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>            <span class="ot">-&gt;</span> <span class="dt">Link</span></span></code></pre></div>
<p>This would work, if we could construct a <em>term</em> of type <code>endpoint</code>… which we can’t, since many of our API component types, like <code>Get a</code>, don’t have constructors. The API component types are entirely for type-level computation; we can’t construct values for them by design.</p>
<p>So, how do we inject type information, without an associated value? <strong>Put down that <code>undefined</code></strong> ಠ_ಠ we don’t do that here. Being respectable, modern Haskellers, we’ll reach for <a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Proxy.html#t:Proxy"><code class="has-text-link">Proxy</code></a>. <code>Proxy</code> is a higher-kinded type that allows us to carry a <em>type witness</em>, without having to construct any values (since the <code>Proxy</code> constructor takes no parameter). It’s defined like so:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Proxy</span> a <span class="ot">=</span> <span class="dt">Proxy</span></span></code></pre></div>
<p>We can now reformulate our class as the final, correct version:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">HasLink</span> endpoint <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink ::</span> <span class="dt">Proxy</span> endpoint</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>           <span class="ot">-&gt;</span> <span class="dt">Link</span> <span class="co">-- ^ Base link</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>           <span class="ot">-&gt;</span> <span class="dt">Link</span></span></code></pre></div>
<p>where the use of <code>Proxy</code> will allow the compiler to infer type information.</p>
<p>Now, we need to write typeclass instances of the class <code>HasLink</code> for all of the building blocks that make up our API. The easiest instances of <code>HasLink</code> are for the terminal verbs, as they do not appear in the endpoint link:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLink</span> (<span class="dt">Get</span> a) <span class="kw">where</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink ::</span> <span class="dt">Proxy</span> (<span class="dt">Get</span> a) <span class="ot">-&gt;</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    toLink _ baselink <span class="ot">=</span> baselink</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLink</span> <span class="dt">Post</span> <span class="kw">where</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink ::</span> <span class="dt">Proxy</span> <span class="dt">Post</span> <span class="ot">-&gt;</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    toLink _ baselink <span class="ot">=</span> baselink</span></code></pre></div>
<p>There’s something else about the terminal verbs, <code>Get</code> and <code>Post</code>: we expect them at the end of our endpoint. There’s no recursion inside <code>toLink</code> here, because by definition, the description of an endpoint as a type always <strong>ends</strong> in <code>Get</code> or <code>Post</code>. These are the base cases.</p>
<p>On the other hand, query parameters and POST request bodies don’t appear in the endpoint link either, but cannot be placed at the end position of the endpoint definition; they are always contained in a <code>(:&gt;)</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLink</span> sub <span class="ot">=&gt;</span> <span class="dt">HasLink</span> (<span class="dt">ReqBody</span> b <span class="op">:&gt;</span> sub) <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink ::</span> <span class="dt">Proxy</span> (<span class="dt">ReqBody</span> b <span class="op">:&gt;</span> sub) <span class="ot">-&gt;</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    toLink _ <span class="ot">=</span> toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> sub)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">HasLink</span> sub <span class="ot">=&gt;</span> <span class="dt">HasLink</span> (<span class="dt">QueryParam</span> name a <span class="op">:&gt;</span> sub) <span class="kw">where</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ot">    toLink ::</span> <span class="dt">Proxy</span> (<span class="dt">QueryParam</span> name a <span class="op">:&gt;</span> sub) <span class="ot">-&gt;</span> <span class="dt">Link</span> <span class="ot">-&gt;</span> <span class="dt">Link</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    toLink _ <span class="ot">=</span> toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> sub)</span></code></pre></div>
<p>Here, we see something different than for <code>Get</code> and <code>Post</code>: the definition of <code>toLink</code> recurs as it moves along the endpoint type.</p>
<p>Let’s pause here for a second, because there’s something very cool that’s easy to miss: we can control what a valid API looks like by NOT writing instances for <code>HasLink</code>. For example, it doesn’t make sense to create a link to <em>something</em> involving <code>:&lt;|&gt;</code>; for example, <code>left :&lt;|&gt; right</code> is for composing endpoints <code>left</code> and <code>right</code> into an API, but there’s no link that makes sense for <code>left :&lt;|&gt; right</code> itself. Well, if we don’t write an instance <code>HasLink (a :&lt;|&gt; b)</code>, we’ll never be able to construct a link to a malformed endpoint, because <code>toLink</code> won’t compile! We’ve transformed the runtime error (<code>Left "..."</code>) from our function <code>endpointLink</code> above, into a <strong>compile-time</strong> error. How awesome is that?!</p>
<p>Let’s climb down from this apotheosis, as it were, and move to the <code>HasLink</code> instance for the path components of endpoints, for which we’ve been using <code>Symbol</code>. Obviously, the type <code>("some-string" :: Symbol)</code> should result in the link fragment <code>("some-string" :: String)</code> somehow. This is one of the advantages of using <code>Symbol</code>: we can use <a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/GHC-TypeLits.html#v:symbolVal"><code class="has-text-link">symbolVal</code></a> to get the value representation of the type-level string, which itself uses the <a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/GHC-TypeLits.html#t:KnownSymbol"><code>KnownSymbol</code> constraint</a>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">KnownSymbol</span> endpoint <span class="ot">=&gt;</span> <span class="dt">HasLink</span> endpoint <span class="kw">where</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    toLink proxy baselink <span class="ot">=</span> baselink <span class="op">&lt;&gt;</span> [symbolVal proxy]</span></code></pre></div>
<p>This is a somewhat complicated way of saying that the following example holds:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="st">&quot;endpoint&quot;</span><span class="ot"> ::</span> <span class="dt">Symbol</span>)) [<span class="st">&quot;/&quot;</span>] <span class="op">==</span> [<span class="st">&quot;/&quot;</span>, <span class="st">&quot;endpoint&quot;</span>]</span></code></pre></div>
<p>where <code>Proxy "endpoint"</code> contains the type-level string <code>"endpoint"</code>, while the right-hand side <code>["/", "endpoint"]</code> is a regular value of type <code>[String]</code>.</p>
<p>With this out of the way, we can write instances for all other types of our API. <code>&lt;some symbol&gt; :&gt; subapi</code> is an interesting one because we recursively use <code>toLink</code> forwards and backwards:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">KnownSymbol</span> super, <span class="dt">HasLink</span> sub) <span class="ot">=&gt;</span> <span class="dt">HasLink</span> (super <span class="op">:&gt;</span> sub) <span class="kw">where</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (super <span class="op">:&gt;</span> sub)) baselink</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span>  toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> super) baselink <span class="co">-- backwards</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> sub) []         <span class="co">-- forwards</span></span></code></pre></div>
<p>For example:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="st">&quot;lastupdated&quot;</span>)) [<span class="st">&quot;/&quot;</span>] <span class="op">==</span> [<span class="st">&quot;/&quot;</span>, <span class="st">&quot;forecast&quot;</span>, <span class="st">&quot;lastupdated&quot;</span>]</span></code></pre></div>
<p><code>Capture</code> is last, and we get to re-use <code>symbolVal</code>. This is because we want to represent the name of the capture parameter, sandwiched between <code>&lt;</code> and <code>&gt;</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">HasLink</span> sub, <span class="dt">KnownSymbol</span> name) <span class="ot">=&gt;</span> <span class="dt">HasLink</span> (<span class="dt">Capture</span> name a <span class="op">:&gt;</span> sub) <span class="kw">where</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="dt">Capture</span> name a <span class="op">:&gt;</span> sub)) baselink</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>        <span class="ot">=</span>  baselink</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> [<span class="st">&quot;&lt;&quot;</span> <span class="op">&lt;&gt;</span> symbolVal (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> name) <span class="op">&lt;&gt;</span> <span class="st">&quot;&gt;&quot;</span>]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&gt;</span> toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> sub) []</span></code></pre></div>
<p>For example:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>toLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;date&quot;</span> <span class="dt">Day</span> <span class="op">:&gt;</span> <span class="st">&quot;temperature&quot;</span>)) [<span class="st">&quot;/&quot;</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">==</span> [<span class="st">&quot;/&quot;</span>, <span class="st">&quot;forecast&quot;</span>, <span class="st">&quot;&lt;date&gt;&quot;</span>, <span class="st">&quot;temperature&quot;</span>]</span></code></pre></div>
<p>We’re almost done. We’ll just wrap <code>toLink</code> to make it easier to use. In particular, we want to represent the list of link segments as a single piece of <code>String</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode haskell literate"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ot">safeLink ::</span> <span class="dt">HasLink</span> endpoint <span class="ot">=&gt;</span> <span class="dt">Proxy</span> endpoint <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>safeLink endpoint</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="fu">mconcat</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span> intersperse <span class="st">&quot;/&quot;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">$</span> toLink endpoint [<span class="st">&quot;/&quot;</span>]</span></code></pre></div>
<p>and boom! We are ready to generate links to our type-leven endpoints. Behold:</p>
<!--
This comment prevents the following from being displayed, but it still gets typechecked

\begin{code}
_ = safeLink (Proxy :: Proxy ("forecast" :> Capture "date" Day :> "temperature" :> Get Temperature))
_ = safeLink (Proxy :: Proxy ("weather" :> "temperature" :> Capture "city" City :> ReqBody Temperature :> Post))
\end{code}
-->
<div class="sourceCode" id="cb24"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a> ghci<span class="op">&gt;</span> safeLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="st">&quot;forecast&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;date&quot;</span> <span class="dt">Day</span> <span class="op">:&gt;</span> <span class="st">&quot;temperature&quot;</span> <span class="op">:&gt;</span> <span class="dt">Get</span> <span class="dt">Temperature</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;/forecast/&lt;date&gt;/temperature&quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a> ghci<span class="op">&gt;</span> safeLink (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="st">&quot;weather&quot;</span> <span class="op">:&gt;</span> <span class="st">&quot;temperature&quot;</span> <span class="op">:&gt;</span> <span class="dt">Capture</span> <span class="st">&quot;city&quot;</span> <span class="dt">City</span> <span class="op">:&gt;</span> <span class="dt">ReqBody</span> <span class="dt">Temperature</span> <span class="op">:&gt;</span> <span class="dt">Post</span>))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;/weather/temperature/&lt;city&gt;&quot;</span></span></code></pre></div>
<hr>
<p>This concludes our first derivation from an API that can be represented by types. This allowed us to create links to endpoints in our API, while ensuring that if an endpoint exists, links to it will be valid. Otherwise, we get a compile-time error!</p>
<p>I wanted to show you this first, because we got acquainted with <a href="https://hackage.haskell.org/package/base-4.21.0.0/docs/Data-Proxy.html#t:Proxy"><code class="has-text-link">Proxy</code></a>, a type that is often seen to help with inference of complex types.</p>
<p>The constructs you have seen in this post are all part of the Servant codebase, although I have simplified things here. This includes <a href="https://hackage.haskell.org/package/servant-0.20.2/docs/Servant-API.html#v:safeLink"><code class="has-text-link">safeLink</code></a>, and the <a href="https://hackage.haskell.org/package/servant-0.20.2/docs/Servant-API.html#t:HasLink"><code class="has-text-link">HasLink</code></a> typeclass. The real <a href="https://hackage.haskell.org/package/servant-0.20.2/docs/Servant-API.html#v:safeLink"><code class="has-text-link">safeLink</code></a> function is notably more powerful for two reasons:</p>
<ul>
<li>You get a compile time error if the endpoint isn’t part of the given API. This means you get even more certainty that the link is valid;</li>
<li>You can feed <code>safeLink</code> the values that go in <code>Capture</code> and <code>QueryParam</code>, to get the true link to the endpoint, rather than having e.g. a <code>&lt;date&gt;</code> placeholder.</li>
</ul>
<p>In the next post, we will go one step further: checking the shape of the server handlers at compile-time. This will require us to use <code>Proxy</code> again, but we’ll also learn about how type families, or type functions, fit in all of this.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>The Servant implementation is more powerful; it gives a type error if the link would point to something that isn’t part of the API we specify. This introduces too much complexity for this blog post, but we may revisit this later.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="content has-text-centered">
                <p>
                    <span class="icon">
                        <i class="fas fa-envelope">
                        </i>
                    </span>
                    <a target="_blank" href="../../email.html">
                        e-mail
                    </a>
                     | 
                    <span class="icon">
                        <i class="fab fa-github">
                        </i>
                    </span>
                    <a target="_blank" href="https://github.com/LaurentRDC">
                        GitHub
                    </a>
                     | 
                    <span class="icon">
                        <i class="fab fa-linkedin">
                        </i>
                    </span>
                    <a target="_blank" href="https://www.linkedin.com/in/laurentrdc">
                        LinkedIn
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-researchgate">
                        </i>
                    </span>
                    <a target="_blank" href="https://www.researchgate.net/profile/Laurent_Rene_De_Cotret">
                        ResearchGate
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-orcid">
                        </i>
                    </span>
                    <a target="_blank" href="https://orcid.org/0000-0002-1464-2739">
                        OrcID
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-google-scholar">
                        </i>
                    </span>
                    <a target="_blank" href="https://scholar.google.ca/citations?user=pXFhwioAAAAJ&amp;hl=en">
                        Google Scholar
                    </a>
                </p>
                <p>
                    <span class="icon">
                        <i class="fas fa-rss">
                        </i>
                    </span>
                    <a target="_blank" href="../../feed.xml">
                        RSS feed
                    </a>
                     | 
                    <span class="icon">
                        <i class="fas fa-atom">
                        </i>
                    </span>
                    <a target="_blank" href="../../atom.xml">
                        Atom feed
                    </a>
                </p>
                <p class="is-small">
                    Page generated on 2025-11-14. 
                    This website was created using free and open-source technologies. 
                    You can learn more about how this website is generated 
                    <a href="../../about-site.html">
                        here
                    </a>
                    .
                </p>
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                    <img alt="Creative Commons License" style="border-width:0" src="../../images/cc-by-sa.svg">
                </a>
            </div>
        </footer>
    </body>
</html>
