<!DOCTYPE HTML>

<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
        <title>
            Harnessing symmetry to find the center of a diffraction pattern - Laurent P. René de Cotret
        </title>
        <link rel="icon" type="image/x-icon" href="../images/atom-solid.png">
        <link rel="stylesheet" type="text/css" href="../css/syntax.css">
        <link rel="stylesheet" type="text/css" href="../css/style.css">
        <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css">
        <link rel="stylesheet" type="font" href="https://fonts.googleapis.com/css?family=Titillium+Web">
        <script type="text/javascript" src="../js/navbar-onclick.js">
        </script>
    </head>
    <body>
        <section class="hero-with-background is-dark">
            <div class="hero-head">
                <nav class="navbar is-transparent">
                    <div class="container">
                        <div class="navbar-brand">
                            <a class="navbar-item has-text-light" href="../index.html">
                                <strong>
                                    Laurent P. René de Cotret
                                </strong>
                            </a>
                            <span class="navbar-burger burger has-text-light" id="burger" onclick="toggleBurger()">
                                <span>
                                </span>
                                <span>
                                </span>
                                <span>
                                </span>
                            </span>
                        </div>
                        <div class="navbar-menu" id="navbarMenu">
                            <div class="navbar-end">
                                <a class="navbar-item" href="../index.html">
                                    Home
                                </a>
                                <a class="navbar-item" href="../software.html">
                                    Software
                                </a>
                                <a class="navbar-item" href="../publications.html">
                                    Publications
                                </a>
                                <a class="navbar-item" href="../about.html">
                                    About me
                                </a>
                                <a class="navbar-item" href="../archive.html">
                                    All blog posts
                                </a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
            <div class="hero-body">
                <div class="container has-text-centered">
                    <h1 class="title has-text-light">
                        Harnessing symmetry to find the center of a diffraction pattern
                    </h1>
                    <h3>
                        Posted on 2021-01-23. Last updated on 2022-02-20.
                    </h3>
                    <h3>
                        Estimated reading time of 29 min.
                    </h3>
                </div>
            </div>
            <div class="hero-foot">
                <div class="navbar is-transparent">
                    <div class="container">
                        <div class="navbar-menu">
                            <div class="navbar-start">
                                <a class="navbar-item has-text-light" target="_blank" href="../email.html">
                                    <span class="icon is-medium">
                                        <i class="fas fa-envelope">
                                        </i>
                                    </span>
                                    e-mail
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://github.com/LaurentRDC">
                                    <span class="icon is-medium">
                                        <i class="fab fa-github">
                                        </i>
                                    </span>
                                    GitHub
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://www.linkedin.com/in/laurent-p-ren%C3%A9-de-cotret-ph-d-296b38152/">
                                    <span class="icon is-medium">
                                        <i class="fab fa-linkedin">
                                        </i>
                                    </span>
                                    LinkedIn
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://www.researchgate.net/profile/Laurent_Rene_De_Cotret">
                                    <span class="icon is-medium">
                                        <i class="ai ai-researchgate">
                                        </i>
                                    </span>
                                    ResearchGate
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://orcid.org/0000-0002-1464-2739">
                                    <span class="icon is-medium">
                                        <i class="ai ai-orcid">
                                        </i>
                                    </span>
                                    OrcID
                                </a>
                                <a class="navbar-item has-text-light" target="_blank" href="https://scholar.google.ca/citations?user=pXFhwioAAAAJ&amp;hl=en">
                                    <span class="icon is-medium">
                                        <i class="ai ai-google-scholar">
                                        </i>
                                    </span>
                                    Google Scholar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <div class="section">
            <div class="container">
                <div class="content">
                    <p>Ultrafast electron diffraction involves the analysis of <em>diffraction patterns</em>. Here is an example diffraction pattern for a thin (&lt;100nm) flake of graphite<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>:</p>
<figure class="python">
<img src="generated/pandocplot14984986905735599799.png" class="image" alt="Diffraction pattern of graphite (Source code)" />
<figcaption aria-hidden="true">Diffraction pattern of graphite (<a href="generated/pandocplot14984986905735599799.src.html">Source code</a>)</figcaption>
</figure>
<p>A diffraction pattern is effectively the intensity of the Fourier transform. Given that crystals like graphite are well-ordered, the diffraction peaks (i.e. Fourier components) are very large. You can see that the diffraction pattern is six-fold symmetric; that’s because the atoms in graphite arrange themselves in a honeycomb pattern, which is also six-fold symmetric. In these experiments, the fundamental Fourier component is so strong that we need to block it. That’s what that black <em>beam-block</em> is about.</p>
<p>There are crystals that are not as well-ordered as graphite. Think of a powder made of many small crystallites, each being about 50nm x 50nm x 50nm. Diffraction electrons through a sample like that results in a kind of average of all possible diffraction patterns. Here’s an example with polycrystalline Chromium:</p>
<figure class="python">
<img src="generated/pandocplot16266849044785217570.png" class="image" alt="Diffraction pattern of polycrystalline Chromium (Source code)" />
<figcaption aria-hidden="true">Diffraction pattern of polycrystalline Chromium (<a href="generated/pandocplot16266849044785217570.src.html">Source code</a>)</figcaption>
</figure>
<p>Each ring in the above pattern pattern corresponds to a Fourier component. Notice again how symmetric the pattern is; the material itself is symmetric enough that the fundamental Fourier component needs to be blocked.</p>
<p>For my work on <a href="https://github.com/LaurentRDC/iris-ued">iris-ued</a>, a data analysis package for ultrafast electron scattering, I needed to find a reliable, automatic way to get the center of such diffraction patterns to get rid of the manual work required now. So let’s see how!</p>
<h2 class="title is-2" id="first-try-center-of-mass">First try: center of mass</h2>
<p>A first naive attempt might start with the <em>center-of-mass</em>, i.e. the average of pixel positions weighted by their intensity. Since intensity is symmetric about the center, the <em>center-of-mass</em> should coincide with the actual physical center of the image.</p>
<p>Good news, <a href="https://docs.scipy.org/doc/scipy/reference/ndimage.html#multidimensional-image-processing-scipy-ndimage">scipy’s <code>ndimage</code> module</a> exports such a function: <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.ndimage.center_of_mass.html#scipy.ndimage.center_of_mass"><code>center_of_mass</code></a>. Let’s try it:</p>
<figure class="python">
<img src="generated/pandocplot16752477837634100088.png" class="image" alt="Demonstration of using scipy.ndimage.center_of_mass to find the center of diffraction patterns. (Source code)" />
<figcaption aria-hidden="true">Demonstration of using <code>scipy.ndimage.center_of_mass</code> to find the center of diffraction patterns. (<a href="generated/pandocplot16752477837634100088.src.html">Source code</a>)</figcaption>
</figure>
<p>Not bad! Especially in the first image, really not a bad first try. But I’m looking for something <em>pixel-perfect</em>. Intuitively, the beam-block in each image should mess with the calculation of the center of mass. Let’s define the following areas that we would like to ignore:</p>
<figure class="python">
<img src="generated/pandocplot4396052407199282587.png" class="image" alt="Areas that are bright are defined as being masked (Source code)" />
<figcaption aria-hidden="true">Areas that are bright are defined as being masked (<a href="generated/pandocplot4396052407199282587.src.html">Source code</a>)</figcaption>
</figure>
<p>Masks are generally defined as boolean arrays with True (or 1) where pixels are valid, and False (or 0) where pixels are invalid. Therefore, we should ignore the weight of masked pixels. <code>scipy.ndimage.center_of_mass</code> does not support this feature; we need an extension of <code>center_of_mass</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> center_of_mass_masked(im, mask):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    rr, cc <span class="op">=</span> np.indices(im.shape)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> im <span class="op">*</span> mask.astype(im.dtype)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> np.average(rr, weights<span class="op">=</span>weights)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> np.average(cc, weights<span class="op">=</span>weights)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r, c</span></code></pre></div>
<p>This is effectively an average of the row and column coordinates (<code>rr</code> and <code>cc</code>) weighted by the image intensity. The trick here is that <code>mask.astype(im.dtype)</code> is 0 where pixels are “invalid”; therefore they don’t count in the average! Let’s look at the result:</p>
<figure class="python">
<img src="generated/pandocplot14343999887317795181.png" class="image" alt="Demonstration of using center_of_mass_masked (see above) to find the center of diffraction patterns. (Source code)" />
<figcaption aria-hidden="true">Demonstration of using <code>center_of_mass_masked</code> (see above) to find the center of diffraction patterns. (<a href="generated/pandocplot14343999887317795181.src.html">Source code</a>)</figcaption>
</figure>
<p>I’m not sure if it’s looking better, honestly. But at least we have an approximate center! That’s a good starting point that feeds in to the next step.</p>
<h2 class="title is-2" id="friedel-pairs-and-radial-inversion-symmetry">Friedel pairs and radial inversion symmetry</h2>
<p>In his thesis<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, which is now also <a href="https://www.springer.com/us/book/9783030548506?utm_campaign=3_pier05_buy_print&amp;utm_content=en_08082017&amp;utm_medium=referral&amp;utm_source=google_books#otherversion=9783030548513">a book</a>, Nelson Liu describes how he does it:</p>
<blockquote>
<p>A rough estimate of its position is obtained by calculating the ‘centre of intensity’ or intensity-weighted arithmetic mean of the position of &gt; 100 random points uniformly distributed over the masked image; this is used to match diffraction spots into Friedel pairs amongst those found earlier. By averaging the midpoint of the lines connecting these pairs of points, a more accurate position of the centre is obtained.</p>
</blockquote>
<p>Friedel pairs are peaks related by inversion through the center of the diffraction pattern. The existence of these pairs is guaranteed by crystal symmetry. For polycrystalline patterns, Friedel pairs are averaged into rings; rings are always inversion-symmetric about their centers. Here’s an example of two Friedel pairs:</p>
<figure class="python">
<img src="generated/pandocplot2702854760294445826.png" class="image" alt="Example of two Friedel pairs: white circles form pair 1, while red circles form pair 2. (Source code)" />
<figcaption aria-hidden="true">Example of two Friedel pairs: white circles form pair 1, while red circles form pair 2. (<a href="generated/pandocplot2702854760294445826.src.html">Source code</a>)</figcaption>
</figure>
<p>The algorithm by Liu was meant for single-crystal diffraction patterns with well-defined peaks, and not so much for rings. However, we can distill Liu’s idea into a new, more general approach. If the approximate center coincides with the actual center of the image, then the image should be invariant under radial-inversion with respect to the approximate center. Said another way: if the image <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math> is defined on polar coordinates <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(r, \theta)</annotation></semantics></math>, then the center maximizes correlation between <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I(r, \theta)</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><mi>r</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I(-r, \theta)</annotation></semantics></math>. Thankfully, computing the masked correlation between images <a href="../posts/mnxc.html">is something I’ve worked on before</a>!</p>
<p>Let’s look at what radial inversion looks like. There are ways to do it with interpolation, e.g. <a href="https://scikit-image.org/docs/stable/api/skimage.transform.html#warp">scikit-image’s <code>warp</code> function</a>. However, in my testing, this is incredibly slow compared to what I will show you. A faster approach is to consider that if the image was centered on the array, then radial inversion is really flipping the direction of the array axes; that is, if the image array <code>I</code> has size (128, 128), and the center is at (64, 64), the radial inverse of <code>I</code> is <code>I[::-1, ::-1]</code> (numpy) / <code>flip(flip(I, 1), 2)</code> (MATLAB) / <code>I[end:-1:1,end:-1:1]</code> (Julia). Another important note is that if the approximate center of the image is far from the center of the array, the overlap between the image and its radial inverse is limited. Consider this:</p>
<figure class="python">
<img src="generated/pandocplot9911019333325395130.png" class="image" alt=" (Source code)" />
<figcaption aria-hidden="true"> (<a href="generated/pandocplot9911019333325395130.src.html">Source code</a>)</figcaption>
</figure>
<p>If we cropped out the bright areas around the frame, then the approximate center found would coincide with the center of the array; then, radial inversion is very fast.</p>
<figure class="python">
<img src="generated/pandocplot11367846076647821.png" class="image" alt="Demonstration of what parts of the image to crop so that the image center coincides with the center of the array. (Source code)" />
<figcaption aria-hidden="true">Demonstration of what parts of the image to crop so that the image center coincides with the center of the array. (<a href="generated/pandocplot11367846076647821.src.html">Source code</a>)</figcaption>
</figure>
<p>Now, especially for the right column of images, it’s pretty clear that the approximate center wasn’t perfect. The <em>correction</em> to the approximate center is can be calculated with the masked normalized cross-correlation<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>:</p>
<figure class="python">
<img src="generated/pandocplot16777817598731895834.png" class="image" alt="Top left: diffraction pattern. Top right: radially-inverted diffraction pattern about an approximate center. Bottom left: masked normalized cross-correlation between the two diffraction patterns. Bottom right: 2x zoom on the cross-correlation shows the translation mismatch between the diffraction patterns. (Source code)" />
<figcaption aria-hidden="true"><strong>Top left</strong>: diffraction pattern. <strong>Top right</strong>: radially-inverted diffraction pattern about an approximate center. <strong>Bottom left</strong>: masked normalized cross-correlation between the two diffraction patterns. <strong>Bottom right</strong>: 2x zoom on the cross-correlation shows the translation mismatch between the diffraction patterns. (<a href="generated/pandocplot16777817598731895834.src.html">Source code</a>)</figcaption>
</figure>
<p>The cross-correlation in the bottom right corner (zoomed by 2x) shows that the true center is the approximate center we found earlier, corrected by the small shift (white arrow)! For single-crystal diffraction patterns, the resulting is even more striking:</p>
<figure class="python">
<img src="generated/pandocplot3573535930999786689.png" class="image" alt="Top left: diffraction pattern. Top right: radially-inverted diffraction pattern about an approximate center. Bottom left: masked normalized cross-correlation between the two diffraction patterns. Bottom right: 2x zoom on the cross-correlation shows the translation mismatch between the diffraction patterns. (Source code)" />
<figcaption aria-hidden="true"><strong>Top left</strong>: diffraction pattern. <strong>Top right</strong>: radially-inverted diffraction pattern about an approximate center. <strong>Bottom left</strong>: masked normalized cross-correlation between the two diffraction patterns. <strong>Bottom right</strong>: 2x zoom on the cross-correlation shows the translation mismatch between the diffraction patterns. (<a href="generated/pandocplot3573535930999786689.src.html">Source code</a>)</figcaption>
</figure>
<p>We can put the two steps together and determine a pixel-perfect center:</p>
<figure class="python">
<img src="generated/pandocplot1965523308818604957.png" class="image" alt=" (Source code)" />
<figcaption aria-hidden="true"> (<a href="generated/pandocplot1965523308818604957.src.html">Source code</a>)</figcaption>
</figure>
<h2 class="title is-2" id="bonus-low-quality-diffraction">Bonus: low-quality diffraction</h2>
<p>Here’s a fun consequence: the technique works also for diffraction patterns that are pretty crappy and very far off center, provided that the asymmetry in the background is taken care-of:</p>
<figure class="python">
<img src="generated/pandocplot4567440637263454083.png" class="image" alt=" (Source code)" />
<figcaption aria-hidden="true"> (<a href="generated/pandocplot4567440637263454083.src.html">Source code</a>)</figcaption>
</figure>
<h2 class="title is-2" id="conclusion">Conclusion</h2>
<p>In this post, we have determined a robust way to compute the center of a diffraction pattern without any parameters, by making use of a strong invariant: radial inversion symmetry. My favourite part: this method admits no free parameters!</p>
<p>If you want to make use of this, <a href="https://scikit-ued.readthedocs.io/en/master/functions/skued.autocenter.html#skued.autocenter">take a look at <code>autocenter</code></a>, a new function that has been added to <a href="https://github.com/LaurentRDC/scikit-ued">scikit-ued</a>.</p>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>L.P. René de Cotret <em>et al</em>, <em>Time- and momentum-resolved phonon population dynamics with ultrafast electron diffuse scattering</em>, Phys. Rev. B <strong>100</strong> (2019) <a href="https://journals.aps.org/prb/abstract/10.1103/PhysRevB.100.214115">DOI: 10.1103/PhysRevB.100.214115</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Liu, Lai Chung. <a href="http://hdl.handle.net/1807/97517">Chemistry in Action: Making Molecular Movies with Ultrafast Electron Diffraction and Data Science</a>. University of Toronto, 2019.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Dirk Padfield. <em>Masked object registration in the Fourier domain</em>. IEEE Transactions on Image Processing, <strong>21</strong>(5):2706–2718, 2012. <a href="https://doi.org/10.1109/TIP.2011.2181402">DOI: 10.1109/TIP.2011.2181402</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Dirk Padfield. <em>Masked FFT registration</em>. Prov. Computer Vision and Pattern Recognition. pp 2918-2925 (2010). <a href="https://doi.org/10.1109/CVPR.2010.5540032">DOI:10.1109/CVPR.2010.5540032</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>
                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="content has-text-centered">
                <p>
                    <span class="icon">
                        <i class="fas fa-envelope">
                        </i>
                    </span>
                    <a target="_blank" href="../email.html">
                        e-mail
                    </a>
                     | 
                    <span class="icon">
                        <i class="fab fa-github">
                        </i>
                    </span>
                    <a target="_blank" href="https://github.com/LaurentRDC">
                        GitHub
                    </a>
                     | 
                    <span class="icon">
                        <i class="fab fa-linkedin">
                        </i>
                    </span>
                    <a target="_blank" href="https://www.linkedin.com/in/laurent-p-ren%C3%A9-de-cotret-ph-d-296b38152/">
                        LinkedIn
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-researchgate">
                        </i>
                    </span>
                    <a target="_blank" href="https://www.researchgate.net/profile/Laurent_Rene_De_Cotret">
                        ResearchGate
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-orcid">
                        </i>
                    </span>
                    <a target="_blank" href="https://orcid.org/0000-0002-1464-2739">
                        OrcID
                    </a>
                     | 
                    <span class="icon">
                        <i class="ai ai-google-scholar">
                        </i>
                    </span>
                    <a target="_blank" href="https://scholar.google.ca/citations?user=pXFhwioAAAAJ&amp;hl=en">
                        Google Scholar
                    </a>
                </p>
                <p>
                    <span class="icon">
                        <i class="fas fa-rss">
                        </i>
                    </span>
                    <a target="_blank" href="../feed.xml">
                        RSS feed
                    </a>
                     | 
                    <span class="icon">
                        <i class="fas fa-atom">
                        </i>
                    </span>
                    <a target="_blank" href="../atom.xml">
                        Atom feed
                    </a>
                </p>
                <p class="is-small">
                    Page generated on 2023-10-19. 
                    This website was created using free and open-source technologies. 
                    You can learn more about how this website is generated 
                    <a href="../about-site.html">
                        here
                    </a>
                    .
                </p>
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
                    <img alt="Creative Commons License" style="border-width:0" src="../images/cc-by-sa.svg">
                </a>
            </div>
        </footer>
    </body>
</html>
