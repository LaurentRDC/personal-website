---
title: pandoc-pyplot, a Pandoc filter to generate Matplotlib figures from code blocks
date: 2018-10-14
summary: To facilitate the integration of Matplotlib plots in documents, I've written a Pandoc filter, `pandoc-pyplot`. Here's how it works.
updated: 2019-03-27
---

I am preparing a series of blog posts on integral transforms. However, I ran into the problem of integrating plots into the document. 

Of course, I could make plots separately, render them as images, and then integrate them like any picture. However, if I want to change the plot, I need to change the file from which the plot was generated. It would be much better if the contents of the plot AND the document were kept in the same file!

## Python world : sphinx and `plot_directive`

In the Python world, integrating plots in documentation generated by [sphinx-doc](http://www.sphinx-doc.org/en/master/) is easy with the [`plot_directive`](https://matplotlib.org/devel/plot_directive.html) extension. For example:

```rst
This is an example RestructuredText document

.. plot ::
    import matplotlib.pyplot as plt
    plt.figure()
    plt.plot([1,2,3,4,5], [1,2,3,4,5])

Text continues below the image
```

The `plot_directive` extension comes with [Matplotlib](https://matplotlib.org/index.html), the _de facto_ standard Python plotting library. The extension is widely used throughout the Python ecosystem, for example to document [scikit-image](https://scikit-image.org/), [pywavelets](https://pywavelets.readthedocs.io/en/latest/), and my own [scikit-ued](https://scikit-ued.readthedocs.io/en/master/).

One great feature of `plot_directive` is that the source code used to generate images is linked to the image, so that readers can inspect the source code from the rendered documents.

With `pandoc-pyplot`, I wanted to replicate the best features from `plot_directive`, applied to a more general setting than Python documentation.

### Aside : why Matplotlib

It makes sense that a Python plotting library, Matplotlib, would be used to document Python packages. But Matplotlib is not only a great Python package: it is a great general-purpose plotting package for all.

Matplotlib is easy to use for quick scripts, as well as extremely customizable. Matplotlib's capabilities extend all the way to publishing-quality figures. As an example, take a look at the first observation of gravitational waves [^1]:

![The gravitational-wave event GW150914 observed by the LIGO Hanford (H1, left column panels) and Livingston (L1, right column panels) detectors.](/images/ligo_fig1.png)

## The pandoc-pyplot filter

What can you do with `pandoc-pyplot` work? All you need to do is to specify a location where to save a rendered file on a code block, like so:

```markdown

    This is a MarkDown document

    ```{.pyplot caption="Trivial example"}

    import matplotlib.pyplot as plt

    plt.figure()
    plt.plot([1,2,3,4,5], [1,2,3,4,5])
    plt.xlabel('Abscissa')
    plt.ylabel('Ordinate')

    ```

    More text

```

`pandoc-pyplot` will run this code block in a Python interpreter, render the output, save the resulting figure in `test.png`, and swap the code block with the rendered image. The result looks like this:

```{.pyplot caption="Example plot generated by pandoc-pyplot. The full Matplotlib API is available at your fingertips."}

import matplotlib.pyplot as plt
import numpy as np

fig, (ax, residuals) = plt.subplots(nrows=2,ncols=1,sharex=True)

# Sine wave with added 30% noise
x = np.linspace(0, 10, 1024)
y = np.sin(x * np.pi/2)
n = 0.3 * (np.random.random(size=x.shape) - 0.5)

ax.plot(x, y + n, 'k.')
ax.plot(x, y, 'r-')
ax.set_ylabel('Intensity [a.u.]')

residuals.plot(x, n, '.k')
residuals.axhline(y=0, color = 'r')
residuals.set_ylabel('Residuals [a.u.]')
residuals.set_xlabel('Time [s]')

```

The source code is just a click away!

`pandoc-pyplot` triggers on code blocks which have a `.pyplot` class. For every such code block, `pandoc-pyplot` does a few things:

1. Add a few lines of Python to capture the plot output in multiple formats.

2. Check that the function `matplotlib.pyplot.show` was not called. This function is used to render the plot to screen, but it is blocking; therefore, we make sure this function is not used in code blocks.

3. Write the script source code to a file so it can be inspected through the source code link.

4. Run the script in a Python interpreter. Because we modified the script to save the figure will be saved where we want it. Python exceptions are captured and shown to you for easier debugging.

5. Replace the code block with an image.

### Source code and availability

You can find more details on installation and usage from the [__GitHub repository__](https://github.com/LaurentRDC/pandoc-pyplot). You can get the latest release on [Hackage](http://hackage.haskell.org/package/pandoc-pyplot).

Look out for upcoming blog posts which will make use of this filter!

[^1]: B. P. Abbott _et al_. (LIGO Scientific Collaboration and Virgo Collaboration), _Observation of Gravitational Waves from a Binary Black Hole Merger_ (2016). Physical Review Letters __116__, 061102. [DOI:10.1103/PhysRevLett.116.061102](https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.116.061102)